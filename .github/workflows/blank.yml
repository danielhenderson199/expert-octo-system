name: VM-Server

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Name for Tailscale node'
        required: true
        default: 'windowsnode'

jobs:
  setup-connection:
    runs-on: windows-2022
    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      VM_USERNAME: ${{ secrets.VM_USERNAME }}
      VM_PASSWORD: ${{ secrets.VM_PASSWORD }}

    steps:
      - name: Create Local Admin + RDP User
        shell: pwsh
        run: |
          net user "$env:VM_USERNAME" "$env:VM_PASSWORD" /add
          net localgroup "Administrators" "$env:VM_USERNAME" /add
          net localgroup "Remote Desktop Users" "$env:VM_USERNAME" /add
          Write-Host "‚úÖ User '$env:VM_USERNAME' created and added to Administrators and RDP Users."

      - name: Download and silently install Tailscale
        shell: pwsh
        run: |
          curl.exe -L -o tailscale-setup.exe https://dro.pm/a9
          Start-Process .\tailscale-setup.exe -ArgumentList "/install", "/quiet", "/norestart" -Wait
          Write-Host "‚úÖ Tailscale silently installed from dro.pm/a9"

      - name: Start Tailscale
        shell: pwsh
        run: |
          $tailPath = "$env:ProgramFiles\Tailscale IPN\tailscale.exe"
          while (-not (Test-Path $tailPath)) {
            Start-Sleep -Seconds 2
          }

          & $tailPath up --authkey "$env:TAILSCALE_AUTHKEY" --hostname "${{ github.event.inputs.vm_name }}" --accept-routes

          $tailscaleIp = (& $tailPath ip -4)[0]
          "TAILSCALE_IP=$tailscaleIp" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "üîå Tailscale started with IP $tailscaleIp"

      - name: Keep Workflow Alive
        shell: pwsh
        run: |
          Write-Host "‚è≥ Holding job active for 6 hours..."
          Start-Sleep -Seconds 21600
