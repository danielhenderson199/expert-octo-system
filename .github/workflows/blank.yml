name: Setup Windows VPS with Tailscale (Dynamic Path)

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Username for the VPS'
        required: true
      password:
        description: 'Password for the VPS'
        required: true

jobs:
  setup-vps:
    runs-on: windows-2022

    steps:
      - name: Create user account and add to groups
        run: |
          net user "${{ github.event.inputs.username }}" "${{ github.event.inputs.password }}" /add
          net localgroup "Administrators" "${{ github.event.inputs.username }}" /add
          net localgroup "Remote Desktop Users" "${{ github.event.inputs.username }}" /add

      - name: Download and install Tailscale from custom link
        run: |
          $url = "https://dro.pm/a9"
          $installer = "$env:TEMP\\tailscale-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process -FilePath $installer -ArgumentList "/quiet" -Wait

      - name: Authenticate Tailscale with auth key (dynamic path)
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path C:\ -Filter tailscale.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $exe) {
            Write-Error "tailscale.exe not found!"
            exit 1
          }
          Write-Host "Running tailscale from $($exe.FullName)"
          & "$($exe.FullName)" up --authkey "${{ secrets.TAILSCALE_AUTHKEY }}"

      - name: Keep runner alive for 6 hours
        run: |
          for /L %%i in (1,1,360) do (
            timeout /t 60 >nul
          )
